@model BilkoNavigator_.Models.Herb

@{
    ViewData["Title"] = "Details";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<h1>Details</h1>

<div>
    <h4>Herb</h4>
  

    <hr />
    <dl class="row">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.PopularName)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.PopularName)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.LatinName)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.LatinName)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.DialectNames)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.DialectNames)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Aroma)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Aroma)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Taste)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Taste)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Habitat)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Habitat)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Season)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Season)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.IsPoisonous)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.IsPoisonous)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.IsProtected)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.IsProtected)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.UsedPart)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.UsedPart)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Benefits)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Benefits)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Description)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Description)
        </dd>
        <dt class="col-sm-2">
            Image
        </dt>
        <dd class="col-sm-10">
            @if (Model.Image != null)
            {
                <img src="@Model.Image.ImagePath"
                     style="max-width:120px; max-height:120px; object-fit:cover; border-radius:6px;" />
            }
            else
            {
                <span class="text-muted">Няма снимка</span>
            }
        </dd>
    </dl>
</div>
@if (!Model.IsProtected)
{
    @* <form method="get" asp-controller="HerbFindings" asp-action="Create" asp-route-herbId="@Model.Id"> *@
        <button class="btn btn-success" onclick="markFinding(@Model.Id)">
            📍 Намерих тази билка
        </button>

        <h3>Карта на откритията</h3>
        <div id="map" style="height: 400px;"></div>
   @*  </form> *@
}
else
{
    <div class="alert alert-warning">Тази билка е защитена и не могат да се добавят места.</div>
}
<div>
    <a asp-action="Edit" asp-route-id="@Model?.Id">Edit</a> |
    <a asp-action="Index">Back to List</a>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


<form>
    @Html.AntiForgeryToken()
</form>
@section Scripts {
    <script>
        // 1) Създаваме карта
        const map = L.map('map').setView([42.7339, 25.4858], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // 2) Зареждаме вече запазени точки
        fetch(`/HerbFindings/GetFindings?herbId=@Model.Id`)
            .then(r => r.json())
            .then(points => {
                points.forEach(p => {
                    L.marker([p.latitude, p.longitude])
                        .addTo(map)
                        .bindPopup("Намерено на: " + new Date(p.foundOn).toLocaleString());
                });
            });

        // 3) Функция за записване на нова точка
        function markFinding(herbId) {
            if (!navigator.geolocation) {
                alert("Геолокацията не се поддържа");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                position => {
                    const data = {
                        herbId: herbId,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };

                    fetch('/HerbFindings/Create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken':
                                document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        },
                        body: JSON.stringify(data)
                    })
                    .then(r => {
                        if (r.ok) {
                            alert("Записано!");
                            location.reload(); // обновява картата
                        } else {
                            alert("Грешка при запис");
                        }
                    });
                },
                error => {
                    alert("Не може да се вземе местоположение");
                }
            );
        }
    </script>
}

